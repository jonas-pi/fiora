# Fiora 项目迁移指南

## 概述

可以直接复制项目文件夹，但需要在新设备上执行一些配置步骤。本指南将帮助你完整地迁移 Fiora 项目。

## 迁移步骤

### 1. 复制项目文件

**可以复制的内容：**
- 整个项目文件夹（除了下面列出的不需要复制的文件）
- 源代码文件
- 配置文件
- `.env2` 或 `.env` 文件（包含配置信息）

**不需要复制的内容（会在新设备上重新生成）：**
- `node_modules/` - 依赖包，需要重新安装
- `dist/` - 构建产物，需要重新构建
- `.linaria-cache/` - 缓存文件
- `coverage/` - 测试覆盖率报告
- `packages/server/public/*` - 前端构建文件（需要重新构建）

**复制方法：**
```bash
# 方法1: 使用 tar 压缩（推荐，保留权限）
cd /home/jonas
tar -czf fiora-backup.tar.gz fiora --exclude='node_modules' --exclude='dist' --exclude='.linaria-cache'

# 传输到新设备后解压
tar -xzf fiora-backup.tar.gz

# 方法2: 使用 rsync（推荐，可以排除多个目录）
rsync -av --exclude='node_modules' --exclude='dist' --exclude='.linaria-cache' \
  --exclude='coverage' /home/jonas/fiora/ user@new-server:/path/to/fiora/

# 方法3: 使用 scp（简单但较慢）
scp -r fiora user@new-server:/path/to/
```

### 2. 在新设备上安装依赖

```bash
# 进入项目目录
cd /path/to/fiora

# 安装项目依赖
yarn install

# 或者使用 npm
npm install
```

### 3. 配置环境变量

**重要：** 确保复制了 `.env2` 或 `.env` 文件，或者手动创建：

```bash
# 创建环境配置文件
cat > .env2 << EOF
JwtSecret=JYDMM622
Administrator=695398a2cc54fa0d14fee368
EOF

# 或者根据新设备的情况修改配置
# 例如修改数据库地址、Redis 地址等
```

**需要检查的配置项：**
- `JwtSecret` - JWT 加密密钥（建议修改为新的随机字符串）
- `Administrator` - 管理员用户 ID（需要在新数据库中重新获取）
- `Database` - MongoDB 数据库地址（如果数据库也在新设备上）
- `RedisHost` / `RedisPort` - Redis 地址和端口
- `Host` / `Port` - 服务端地址和端口

### 4. 迁移数据库（MongoDB）

**如果数据库在同一台设备上：**

```bash
# 方法1: 使用 mongodump 和 mongorestore（推荐）
# 在旧设备上导出
mongodump --db fiora --out /path/to/backup

# 传输备份文件到新设备
scp -r /path/to/backup user@new-server:/path/to/

# 在新设备上恢复
mongorestore --db fiora /path/to/backup/fiora
```

**如果数据库在不同设备上：**
- 修改 `.env2` 或 `.env` 中的 `Database` 配置项
- 确保新设备可以访问 MongoDB 服务器

**如果使用新的数据库：**
- 数据库会自动创建
- 但需要重新注册用户或迁移用户数据

### 5. 迁移 Redis 数据（可选）

**如果使用 Redis 存储配置：**

```bash
# 在旧设备上导出 Redis 数据
redis-cli --rdb /path/to/redis-backup.rdb

# 传输到新设备
scp /path/to/redis-backup.rdb user@new-server:/path/to/

# 在新设备上恢复（需要停止 Redis 服务）
# 将备份文件复制到 Redis 数据目录，然后重启 Redis
```

**注意：** 如果 Redis 只用于缓存，可以跳过此步骤，配置会从环境变量重新加载。

### 6. 迁移上传的文件（如果存储在服务器上）

**如果文件存储在服务器本地：**

```bash
# 复制上传的文件目录
# 默认位置：packages/server/public/
rsync -av packages/server/public/ user@new-server:/path/to/fiora/packages/server/public/
```

**如果使用阿里云 OSS：**
- 无需迁移，文件已存储在云端

### 7. 重新构建前端

```bash
# 在新设备上构建前端
NODE_OPTIONS=--openssl-legacy-provider yarn build:web

# 或者如果 Node.js 版本 < 17
yarn build:web
```

### 8. 启动服务

```bash
# 启动服务
yarn start

# 或使用 pm2 在后台运行
pm2 start yarn --name fiora -- start
```

## 快速迁移脚本

创建一个迁移脚本可以简化流程：

```bash
#!/bin/bash
# migrate-fiora.sh

# 1. 安装依赖
echo "安装依赖..."
yarn install

# 2. 检查环境变量文件
if [ ! -f .env2 ] && [ ! -f .env ]; then
    echo "警告: 未找到环境配置文件，请手动创建 .env2 或 .env"
fi

# 3. 构建前端
echo "构建前端..."
NODE_OPTIONS=--openssl-legacy-provider yarn build:web

# 4. 检查 MongoDB 连接
echo "检查 MongoDB 连接..."
# 可以添加 MongoDB 连接检查

# 5. 检查 Redis 连接
echo "检查 Redis 连接..."
# 可以添加 Redis 连接检查

echo "迁移完成！请检查配置后启动服务：yarn start"
```

## 迁移检查清单

迁移完成后，请检查以下项目：

- [ ] 项目文件已复制
- [ ] 依赖已安装（`yarn install`）
- [ ] 环境变量已配置（`.env2` 或 `.env`）
- [ ] MongoDB 数据库已迁移或配置
- [ ] Redis 已配置（如果需要）
- [ ] 上传的文件已迁移（如果存储在本地）
- [ ] 前端已构建（`yarn build:web`）
- [ ] 服务可以正常启动
- [ ] 可以正常访问网页
- [ ] 管理员账号可以登录
- [ ] 数据库连接正常

## 常见问题

### Q: 复制 node_modules 可以吗？

**A:** 不推荐。因为：
- node_modules 很大，传输慢
- 不同操作系统/架构可能不兼容
- 可能包含平台特定的二进制文件

建议在新设备上重新安装依赖。

### Q: 如何迁移用户数据？

**A:** 用户数据存储在 MongoDB 中，使用 `mongodump` 和 `mongorestore` 即可完整迁移。

### Q: 管理员 ID 在新设备上不生效？

**A:** 如果数据库是新的，用户 ID 会不同。需要：
1. 在新设备上注册管理员账号
2. 使用 `fiora getUserId <username>` 获取新的用户 ID
3. 更新 `.env2` 中的 `Administrator` 配置
4. 重启服务

### Q: 如何验证迁移是否成功？

**A:** 
1. 检查服务是否正常启动
2. 访问网页是否可以打开
3. 尝试登录
4. 检查管理员功能是否正常
5. 检查数据库连接是否正常

## 注意事项

1. **JwtSecret 安全：** 如果迁移到生产环境，建议修改 `JwtSecret` 为新的随机字符串
2. **数据库备份：** 迁移前务必备份原数据库
3. **端口冲突：** 确保新设备上的端口（默认 9200）未被占用
4. **防火墙：** 确保新设备的防火墙允许相应端口访问
5. **文件权限：** 确保新设备上的文件权限正确

## 最小化迁移（仅代码）

如果只需要迁移代码修改，不需要数据：

```bash
# 只复制源代码
rsync -av --exclude='node_modules' --exclude='dist' \
  --exclude='.linaria-cache' --exclude='coverage' \
  --exclude='packages/server/public' \
  /home/jonas/fiora/ user@new-server:/path/to/fiora/

# 在新设备上
cd /path/to/fiora
yarn install
yarn build:web
# 配置环境变量
yarn start
```

## 完整迁移（包含数据）

如果需要完整迁移包括所有数据：

1. 复制项目文件（排除 node_modules、dist 等）
2. 迁移 MongoDB 数据库
3. 迁移 Redis 数据（如果使用）
4. 迁移上传的文件
5. 在新设备上安装依赖
6. 重新构建前端
7. 配置环境变量
8. 启动服务

