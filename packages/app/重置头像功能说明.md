# 重置头像功能说明

## 功能概述

移动端应用现在支持将用户头像重置为系统随机默认头像。当用户发送空字符串给 `changeAvatar` 接口时，服务端会自动将头像重置为随机默认头像（从 `/avatar/0.jpg` 到 `/avatar/14.jpg` 中随机选择一个）。

## 实现方式

### 服务端实现（方案一：支持空字符串重置）

服务端的 `changeAvatar` 接口已支持空字符串重置：

- **接口名称：** `changeAvatar`
- **请求参数：** `{ avatar: "" }` （空字符串表示重置）
- **响应格式：** `{ avatar: "/avatar/X.jpg" }` （返回随机选择的默认头像URL，X 为 0-14 之间的随机数）

### 移动端使用方式

#### 方法一：使用 changeAvatar 函数（推荐）

```typescript
import { changeAvatar } from '../service';
import action from '../state/action';

// 重置头像为随机默认头像
async function resetAvatar() {
    const newAvatarUrl = await changeAvatar('');
    if (newAvatarUrl) {
        // 更新本地状态
        action.setAvatar(newAvatarUrl);
        console.log('头像已重置为随机默认头像:', newAvatarUrl);
    } else {
        console.error('重置头像失败');
    }
}
```

#### 方法二：直接使用 fetch

```typescript
import { fetch } from '../service';
import action from '../state/action';

async function resetAvatar() {
    const [error, result] = await fetch('changeAvatar', { avatar: '' });
    if (!error && result) {
        action.setAvatar(result.avatar);
        console.log('头像已重置为:', result.avatar);
    } else {
        console.error('重置头像失败:', error);
    }
}
```

## 完整示例

以下是一个完整的组件示例，展示如何实现头像重置功能：

```typescript
import React from 'react';
import { Button, View, Text } from 'react-native';
import { changeAvatar } from '../service';
import action from '../state/action';
import { useUser } from '../hooks/useStore';

function AvatarSettings() {
    const user = useUser();

    async function handleResetAvatar() {
        try {
            const newAvatarUrl = await changeAvatar('');
            if (newAvatarUrl) {
                // 更新本地状态
                action.setAvatar(newAvatarUrl);
                // 可以显示成功提示
                alert('头像已重置为随机默认头像');
            } else {
                alert('重置头像失败，请重试');
            }
        } catch (error) {
            console.error('重置头像错误:', error);
            alert('重置头像失败，请重试');
        }
    }

    return (
        <View>
            <Text>当前头像: {user.avatar}</Text>
            <Button 
                title="重置为默认头像" 
                onPress={handleResetAvatar}
            />
        </View>
    );
}
```

## 技术细节

### 服务端实现

- **文件位置：** `packages/server/src/routes/user.ts`
- **函数：** `changeAvatar`
- **逻辑：**
  1. 检查 `avatar` 参数是否为空字符串或只包含空格
  2. 如果为空，使用 `getRandomAvatar()` 随机生成默认头像URL（从 `/avatar/0.jpg` 到 `/avatar/14.jpg` 中随机选择）
  3. 如果不为空，验证并更新为用户提供的头像URL
  4. 返回新的头像URL

### 移动端实现

- **文件位置：** `packages/app/src/service.ts`
- **函数：** `changeAvatar(avatar: string): Promise<string | null>`
- **返回值：**
  - 成功：返回新的头像URL字符串
  - 失败：返回 `null`

## 注意事项

1. **默认头像路径：** 默认头像从 `/avatar/0.jpg` 到 `/avatar/14.jpg` 共15个文件中随机选择，确保这些文件存在于服务器
2. **随机性：** 每次重置头像都会随机选择一个默认头像，避免所有用户头像相同
3. **向后兼容：** 此实现完全向后兼容，不影响现有的头像上传功能
4. **错误处理：** 建议在调用时添加适当的错误处理和用户提示
5. **状态同步：** 重置成功后，记得调用 `action.setAvatar()` 更新本地状态

## 测试建议

1. **测试空字符串重置：**
   ```typescript
   const result = await changeAvatar('');
   console.assert(result && result.startsWith('/avatar/') && result.endsWith('.jpg'), '应该返回随机默认头像URL');
   // 多次调用应该返回不同的头像（概率很高）
   ```

2. **测试正常头像更新：**
   ```typescript
   const result = await changeAvatar('https://example.com/avatar.jpg');
   console.assert(result === 'https://example.com/avatar.jpg', '应该返回用户提供的URL');
   ```

3. **测试错误处理：**
   ```typescript
   // 测试网络错误等情况
   ```

## 更新日志

- 2024-01-03: 实现方案一（支持空字符串重置），服务端和移动端代码已更新

