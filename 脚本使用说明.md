# Fiora 脚本使用说明

## 概述

Fiora 内置了一个命令行工具，用于管理服务器。这些脚本可以直接修改数据库，因此在使用前**强烈建议备份数据库并停止服务端**。

### ⚠️ 重要提示：命令参数格式

在文档中，`<参数名>` 表示需要替换的实际值，**不要包含尖括号 `<` 和 `>`**。

**错误示例：**
```bash
# ❌ 错误：不要包含尖括号
fiora getUserId <jonas>
npx ts-node index.ts register <username> <password>
```

**正确示例：**
```bash
# ✅ 正确：直接使用实际值
fiora getUserId jonas
npx ts-node index.ts register username password123
```

## 安装和设置

### 1. 确保项目依赖已安装

```bash
# 进入项目目录
cd /home/jonas/fiora

# 安装项目依赖
yarn install
```

### 2. 查看可用命令

**方式 1: 使用项目内的包装脚本（推荐）**

```bash
# 在项目根目录下，使用包装脚本
./bin/fiora

# 或者使用完整路径
/home/jonas/fiora/bin/fiora
```

**方式 2: 使用 npx 直接执行**

```bash
# 使用 npx 直接执行，查看所有可用的脚本命令
npx ts-node index.ts
```

**方式 3: 添加到 PATH（可选，方便全局使用）**

```bash
# 将 fiora 脚本目录添加到 PATH（临时，当前会话有效）
export PATH="$PATH:/home/jonas/fiora/bin"

# 然后可以直接使用 fiora 命令
fiora

# 永久添加到 PATH（推荐添加到 ~/.bashrc 或 ~/.zshrc）
echo 'export PATH="$PATH:/home/jonas/fiora/bin"' >> ~/.bashrc
source ~/.bashrc

# 之后就可以在任何地方使用 fiora 命令了
fiora getUserId jonas
```

**注意：** 
- 如果执行 `fiora` 命令时提示 "Command 'fiora' not found"，请使用 `./bin/fiora` 或 `npx ts-node index.ts` 的方式执行
- `yarn link` 方法对 TypeScript 项目可能不生效，建议使用上述方式

## 可用脚本命令

### 1. deleteMessages - 删除所有历史消息

**命令格式：**
```bash
npx ts-node index.ts deleteMessages
```

**功能说明：**
- 删除所有历史消息记录
- 如果消息图片和文件存储在服务器上，也可以一并删除

**使用示例：**
```bash
npx ts-node index.ts deleteMessages
```

---

### 2. deleteTodayRegisteredUsers - 删除当天注册的用户

**命令格式：**
```bash
npx ts-node index.ts deleteTodayRegisteredUsers
```

**功能说明：**
- 删除当天（以服务器时间为准）新注册的所有用户

**使用示例：**
```bash
npx ts-node index.ts deleteTodayRegisteredUsers
```

---

### 3. deleteUser - 删除指定用户

**命令格式：**
```bash
npx ts-node index.ts deleteUser <userId>
```

**参数说明：**
- `<userId>`: 要删除的用户 ID（**注意：实际使用时不要包含尖括号，直接写用户ID**）

**功能说明：**
- 删除指定用户
- 同时删除其历史消息
- 退出其已加入的群组
- 删除其所有好友关系

**使用示例：**
```bash
# 删除用户 ID 为 695398a2cc54fa0d14fee368 的用户
npx ts-node index.ts deleteUser 695398a2cc54fa0d14fee368

# 或者使用 fiora 命令（如果已链接）
fiora deleteUser 695398a2cc54fa0d14fee368
```

---

### 4. doctor - 检查服务端配置和状态

**命令格式：**
```bash
npx ts-node index.ts doctor
```

**功能说明：**
- 检查服务端配置和状态
- 可以用来定位服务端启动失败的原因
- 检查项目包括：
  - Node.js 版本
  - MongoDB 连接状态
  - Redis 连接状态
  - 端口占用情况
  - 前端构建文件是否存在

**使用示例：**
```bash
npx ts-node index.ts doctor
```

---

### 5. fixUsersAvatar - 修复用户头像路径

**命令格式：**
```bash
npx ts-node index.ts fixUsersAvatar [searchValue] [replaceValue]
```

**参数说明：**
- `[searchValue]`: 可选，要搜索的路径值
- `[replaceValue]`: 可选，要替换的路径值

**功能说明：**
- 修复用户错误头像路径
- 请根据你的实际情况修改脚本判断逻辑

**使用示例：**
```bash
# 修复所有用户头像路径
npx ts-node index.ts fixUsersAvatar

# 将头像路径中的 old-path 替换为 new-path
npx ts-node index.ts fixUsersAvatar old-path new-path
```

---

### 6. getUserId - 获取用户 ID

**命令格式：**
```bash
npx ts-node index.ts getUserId <username>
```

**参数说明：**
- `<username>`: 用户名（**注意：实际使用时不要包含尖括号，直接写用户名**）

**功能说明：**
- 获取指定用户名的 userId

**使用示例：**
```bash
# 获取用户名为 "jonas" 的用户 ID
npx ts-node index.ts getUserId jonas

# 或者使用 fiora 命令（如果已链接）
fiora getUserId jonas

# 输出示例：
# The userId of [jonas] is: 695398a2cc54fa0d14fee368
```

---

### 7. register - 注册新用户

**命令格式：**
```bash
npx ts-node index.ts register <username> <password>
```

**参数说明：**
- `<username>`: 新用户的用户名（**注意：实际使用时不要包含尖括号，直接写用户名**）
- `<password>`: 新用户的密码（**注意：实际使用时不要包含尖括号，直接写密码**）

**功能说明：**
- 注册新用户
- 当禁止注册时，可以由管理员通过此命令注册新用户

**使用示例：**
```bash
# 注册一个用户名为 "newuser"，密码为 "password123" 的新用户
npx ts-node index.ts register newuser password123

# 或者使用 fiora 命令（如果已链接）
fiora register newuser password123
```

---

### 8. updateDefaultGroupName - 更新默认群组名

**命令格式：**
```bash
npx ts-node index.ts updateDefaultGroupName <newName>
```

**参数说明：**
- `<newName>`: 新的默认群组名称（**注意：实际使用时不要包含尖括号，直接写群组名，如果包含空格需要用引号包裹**）

**功能说明：**
- 更新默认群组名

**使用示例：**
```bash
# 将默认群组名更新为 "我的聊天室"（包含空格，需要用引号）
npx ts-node index.ts updateDefaultGroupName "我的聊天室"

# 或者不包含空格时不需要引号
npx ts-node index.ts updateDefaultGroupName MyGroup

# 或者使用 fiora 命令（如果已链接）
fiora updateDefaultGroupName "我的聊天室"
```

## 使用注意事项

### ⚠️ 重要提示

1. **备份数据库**：这些脚本大多会直接修改数据库，执行前请务必备份数据库
2. **停止服务端**：建议在执行脚本前停止服务端，避免数据不一致
3. **谨慎操作**：删除操作不可逆，请确认后再执行
4. **权限要求**：确保有足够的数据库访问权限

### 执行方式

**方式 1: 使用项目内的包装脚本（推荐）**

```bash
# 基本格式（在项目根目录下）
./bin/fiora <command> [args]

# 示例：查看帮助
./bin/fiora

# 示例：删除所有消息
./bin/fiora deleteMessages

# 示例：注册新用户
./bin/fiora register newuser password123

# 示例：检查服务端状态
./bin/fiora doctor

# 示例：获取用户 ID
./bin/fiora getUserId jonas
```

**方式 2: 添加到 PATH 后全局使用（推荐，方便）**

```bash
# 首先添加到 PATH（只需执行一次）
echo 'export PATH="$PATH:/home/jonas/fiora/bin"' >> ~/.bashrc
source ~/.bashrc

# 之后可以在任何地方使用
fiora doctor
fiora getUserId jonas
fiora register newuser password123
```

**方式 3: 使用 npx 直接执行**

```bash
# 基本格式
npx ts-node index.ts <command> [args]

# 示例
npx ts-node index.ts doctor
npx ts-node index.ts getUserId jonas
npx ts-node index.ts register newuser password123
```

## 常见问题

### Q: 执行 `fiora` 命令提示找不到命令？

**A:** 有多种解决方案：

1. **推荐方案 1**：使用项目内的包装脚本
   ```bash
   # 在项目根目录下
   ./bin/fiora doctor
   ./bin/fiora getUserId jonas
   ```

2. **推荐方案 2**：将脚本目录添加到 PATH（永久解决方案）
   ```bash
   # 添加到 ~/.bashrc（永久生效）
   echo 'export PATH="$PATH:/home/jonas/fiora/bin"' >> ~/.bashrc
   source ~/.bashrc
   
   # 之后就可以直接使用
   fiora doctor
   ```

3. **方案 3**：直接使用 `npx ts-node index.ts`
   ```bash
   npx ts-node index.ts doctor
   npx ts-node index.ts getUserId jonas
   ```

4. **不推荐**：`yarn link` 对 TypeScript 项目可能不生效，因为 `bin` 指向的是 `.ts` 文件而不是可执行脚本。

### Q: 执行命令时提示 "syntax error near unexpected token"？

**A:** 这通常是因为在命令参数中使用了尖括号 `<` 和 `>`。文档中的 `<参数名>` 只是表示需要替换的占位符，实际使用时**不要包含尖括号**。

**错误示例：**
```bash
# ❌ 错误：包含尖括号会导致 bash 语法错误
fiora getUserId <jonas>
```

**正确示例：**
```bash
# ✅ 正确：直接使用实际值
fiora getUserId jonas
npx ts-node index.ts getUserId jonas
```

### Q: 脚本执行失败，提示数据库连接错误？

**A:** 确保以下服务正在运行：

1. **MongoDB** 服务已启动
   ```bash
   # 检查 MongoDB 是否运行
   systemctl status mongod
   # 或
   ps aux | grep mongod
   ```

2. **Redis** 服务已启动
   ```bash
   # 检查 Redis 是否运行
   systemctl status redis
   # 或
   ps aux | grep redis
   ```

3. 检查配置文件（`.env` 或 `.env2`）中的数据库连接信息是否正确

### Q: 如何查看脚本的详细帮助信息？

**A:** 执行以下命令查看所有可用命令：

```bash
# 查看所有命令列表
npx ts-node index.ts

# 查看特定命令的帮助
npx ts-node index.ts <command> --help
```

### Q: 执行脚本时提示 i18n 相关错误？

**A:** 如果遇到 `Cannot read properties of undefined` 错误，可能是 i18n 配置问题。已修复此问题，请确保使用最新代码。

### Q: 脚本执行需要什么权限？

**A:** 
- 读取数据库的权限
- 修改数据库的权限（删除、更新操作）
- 访问项目文件的权限

确保当前用户有足够的权限执行这些操作。

## 相关文件位置

- 脚本入口：`/index.ts`
- 脚本实现：`/packages/bin/index.ts`
- 具体脚本：`/packages/bin/scripts/` 目录下

